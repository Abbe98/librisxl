def bibIdList = "'cwpsmzsp5hvvm7t', 'g0swqlws5b4535v', '5phm3frh1q5xxqd', 'j2v0rr7v5kv8z7h', '1kcjck1c0b7pfsv', '4ngprsfg5r76vxm', 'q829czx21sq13q2', 'g0s1jvds3w4dtzf', 'zh9kh7p95j67grt', 'vd6gvlw63365ckz', 'sb4f5rw42pzpv27', 'fzr2t65r4srvsdr', 'bvnzwmtn22xrt29', 'r93ddpr31fzwbsl', 'h1t46t4t12vgm6b', '4ngr89pg03d48nb', 'zh9l4lb91mrm2fd', 'n60bg5l0081jnzb', '9tmzbmsm3tn7gkd', '5h43n3p83x5m8ntz', 'w7vtcg1bt6thc05v', 'tc5h0qm50kz1l6q', 'r93g4hz32st8bh4', 'q82f8r9241dvl1z', '4ngttgwg32s72sx', '2ldrq60d0sfrz09', 'bvn10gbn2xm9ldh', '4ngttgzg4rqmk4q', '2ldrrd8d4b588lf', 'r93gg5q343gf6bl', '5phvvklh3pplcvr', 'cwp22rdp2gbbv2k', 'xg8mmck80x1441l', '0jbppfmb3pqsv17', '3mfssjqf1978qx7', 'm5zbb1nz2b1hcjm', 'q82ff5d24ljtbwl', 'q82ff4t224xgbjw', 'tc5jj7x54dvf7jx', 'dxq33xxq2bk0x17', 'p71dd1r13r3nflw', 'vd6kk6x61dlngpb', 'wf7ll7074plwv0k', '9tm00nvm3dbxmt4', 'n60cc3p00bwvk06', 'wf7llgs74bqxn60', 'n60cc3r05m9ctcv', 'tc5jj5151ccrv1z', '1kcqqmgc529f2r6', '3mfssn1f53jjkb9', 'g0s55xqs4l7hn2l', 'g0s550xs5c6352p', 'r93ggjt33g00vgm', '3mfssv5f396vwm8', '9tm0017m58ptpf5', '2ldrr0rd5v20r93', '4ngtthdg3p9r0k0', 'tc5jj64557fntjg', '3mfsswkf5fhztzn', 'q82ffm921bkj24z', '5phvvw8h3f9z4vr', 'cwp2244p165k5bl', '3mfsszpf19k48s8', 'l4x99cdx13mw5w5', '6qjww2vj10rd76n', '5phvv19h3bh6w5g', '2ldrrx7d2m1lz5d', 'l4x99j7x3xjwjwr', '3mfsszbf28sjtq5', 'sb4hhn243xfqhgs', '3mfsszdf3hsf4t1', 'zh9npc191vb9xz4', 'vd6kpmt63bx2r4x', 'sb4hmnp44kb6h6s', '7rkx5k9k118l9sv', 'j2v7g58v5vksh81', '5phv3s6h4l7d69x', 'j2v7g5kv1mt1h29', '5phv33hh3xf3cqs', 'p71fs8j10d4s4nq', '9tm002bm1k3rq0m', '0jbrntrb1qf89dx', 'fzr6482r4vb7w6r', 'r93jh4b30gkj5tp', 'vd6m5nf65lqfd5n', 'vd6nb2562tlx125', 'j2vb67bv5686gd7', 'wf7pkmz70lc1b3t', 'j2vb68mv0s7d861', '6qj0zpcj30h8prt', '4ngxwnkg1dt4xds', 'cwp55zsp5t6lkxb', 'zh9rrkf94z90q5t', 'n60ggx305cjm8jc', '6qj02jpj2sgnfc7', '1kctvb8c3lbn7vd', '4ngx12vg0nvm0r9', 'fzr7f15r3nwf229', 'q82jq4q20xkltsv', 'cwp5cz4p3lhq597', 'cwp5b0rp4vbklzl', '3mfgr7zf5ng7htp', 'bvnqstwn3bml9xs', 'xg8qk5584hl2bp6', 'r93kk5c322x2l6s', 'sb4hmkm41qnbttp', 'dptwrm1hb7zjphhc', '2ldrz40d08sfz94', '6qjk352j0xsm1q0', '3mfwxd7f2f8lp6q', 's930n3j45189h45', 'q82ff52237qmjtf', 'q82fmsr2264l88z', 'r937vxc32hpdmn5', 'tc5jjpl52vgknfs', 'vd6g3gz633wdldd', 'l4x9j04x0hv2vw7', '0jbptvhb33rwcm4', 'xg8mmgz80ddh8pk', 'n606wws05fpxm0g', '0jbppjkb48fmlc1', 'ktvxmzwcht72b73j', 'fzr0mzhr4c41xjz', 'bvn2crpn34hq3zf', '0jbl1gfb2l1fgkr', '0jbpxcqb08m0wnj', 'sb4hq5941b90flk', '2ldh8tqd09t5kds', '7rkw00mk49vtbmr', '7rkxxm9k425rfj6', '9tm2jfvm5qfql2l', 'kv0219c1hqhl052p', '6qjsgh9j29d51cx', '9tm005gm589v65j', 'dxq375wq0qd65ql', 'bvnr44xn1thdw7h', '0jbpn4rb42rgngr', 'm5zbgddz1zr0p0b', '7qj783zk2bt1kqt', '09s22gxkxhzs8hh7', '4ngq79rg4wcc7jc', 'w6pzxgsgt1n4mtbc', 'p71hcdk14rz9xbn', 'bmrtqrtx8f20p2fk', 'xg8mmb380fkt60q', 'p60n0xr1483qnwh', 'tc5ljlv505qtx6b', '5phtx0xh14x08sx', '2ldh7s6d20zjf9d', '8j4zd50r6gqc79h2', 'm5zbk0mz097h5t6', 'cn66gzd19m37sbg2', '1kcsp28c2ggzf2v', '3c36rxlw17636zsz', '4nglmdlg01xd6sj', '0jbg0p3b18vc2qx', '1kcnnz2c45jpkkj', 'fzr0z8tr45cn3b7', '2ldjfmnd1x4dd8d', 'r93ggm031n1ntlg', '1kcpb8qc3gx148t', '3mfjr5qf547371f', '8slztfll5lx3nqt', 'cwp264cp2kx5lgf', 'bm55jrzd8w3sv1pp', '9l086lht73809ppz', '5fm08m8k3mb2sbpc', 'mx2wfnzrkts8dvsc', 'v594gs9bsgww9jh5', '09f8zhrlxkcglt02', 'q150vv8wn6srjn64', 'z7fs15npw7mhd6jl', 'cn54lxvd9s7cvfm0', 'mwx0tvxckxh7h0r3', 'pz51dbw4ml8jqfrw', '7rk12m8k1nzrrqj', 'z9zxq2wzwpcn3x1n', 'm5zf70rz1lwvs7b', '7k760lzr5dr4vt5f', 'p0j96ds4mclx1rl0', '7hvfkq195bw2r108', '08g4zfqnxlbp25xn', 't5ttvl5jrx4p9n97', '6gnfxmp64zwblq43', 'dnvm2h5dblrh32t0', '08m6d8hbxm67tm0s', 'pzkdvbwgm2lvnpx1', '09zddfdnxhhbfjx5', '5g4kk1fx3kqnctk9', 'bl7m880r85r4qdt7', 's37940rgqmp2jnwz', 'hr1m7b7qfgg663gr', 'nx642vfglbppgzqz', '7hjl8ck351lf26mz', '4ds192ml20tm5mg0', 'r2ktvxxrppsw22tq', '6gqxmt1m4dgdp752', 'n603ft101rm9j7c', '0jbf8g6b2494355', 'dxqzrnpq5k1jc3c', 'zh9kpj391n3l5rz', 'lxllncj5j3tq5jzc', 'w5jqw4h6tg537979', 'fzr44r9r0ks6x8s', 'm5zbb1bz28tx07v', 'xg8cpvn81bpf0gg', 'g0s56vgs1pz479k', '8slz0n9l0g81jll', 'lvwzmxrkj71qqn58', 'z7f312wtw7f56wj1', '7h39sjg7529zdpcb', '5f171v3h37spgq4w', 'zh9nnhx945m8223', 'tc5l47051lm9ghf', 'fqw4cqp9cq3txl17', '8j42qgld6pnlv02l', 'zh9nn9s9328kbg0', 'bvn11w4n1xrvx6w', 'cm130h399prlxdgw', 'w5kn7682tq5p3c33', '3mfstjxf0bhbcvb', 'pz3s355kmh3mqw24', 'gq3nvx1pd95hp757', 'q82cf8720dr6rp0', 'tc5gxhx5298z7mv', '4fkd3rk32c8z56l9', 'kv0t8sr5hscvxj8w', 'kv0t835vhkkdmfqd', '8kpj0fwz6z0fw50t', '8kpj1mq3654ggvfd', '09f8rt9sxd0ldwkz', '5f0sfs163lmbmztx', 'lvff207nj1sk1k7v', 't395jxr3rfqwzs97', '4dzzr7rv2qmftvlx', '3cxxrrrz1ff9qh5r', 'p71ddh510m5j3t1', 'q828z0d218jhkfz', '7rkzd6sk4ltl53g', 'cwps344p14587qk', '3czw7hc71h075lck', '8jrbtb376xhsdfkr', '1bn3l8z2zr2qmxvw', 'bl554bz08mzpcxhs', 'bmzd6b5r8hbsk5fg', 'gr3jbrvwdbm27wq6', 'q1ctqb2lnpwcz14m', 'p0bspfjbmmqhl926', '0jbqq29b1cd8z8x', 'g0s5vl8s2gfmq88', 'xg89gr782rg33qq', 'k3w86gxw36x1fn4', '8jqlw0fq6xzjp050', 'v4b6n0rxs8jttcb4', 'gqxs5slnd1j6fvhd', 'q05chpr7n7rlbpg7', 'x6d2w902v8wqspkk', 'hrzqf11pfjxz13bk', 'k3w6q6mw1n96d32', 'z78b0nmwwp6hfxhz', 'dxqsr5vq0ccc8tf', '9tm06gjm1dxk9mb', '0jbfmn7b3hxjd8s', 'm5zbbhwz59j777k', '6ghk8g554h07r7n9', 'cn0ksnw59n98b330', 'n601mcd04m0c2lf', 'jvmlbljwg3crt24f', 'p714bj713bc74pw', 'l4x6pr6x1hqhqm0', 'jtfw4wqmg1w7qpcn', 'r93c2x935ln11jw', 'vd6ks7063n5xzpg', 'zh9g9nz92vc8q9x', '2c8xlnsv07x4d03k', 'q82ggsz202w7sjf', '9tm007zm0gxg74x', 'zh9k3fq912jz5k8', '5phvvp9h2j9xr2z', 'xg8mmc981lltdr4', 'x6nvcxpmvcdrs91x', 'j2v77vpv0tsjxbl', 'fzr446hr05lcttr', '4g68nsxg238khwbc', 'cpfhxn1t9zhj3rdh', 'zh9nnhf94fms8h4', 'p075j1ckmsjdbkjm', '09hv6kgzxh5h7060', 'tc5jj8z528zh8g5', '08gbn8npx8fjsv4z', '6gmck7nb4k9ngtq2', 'fzr6k86r3p06nvj', '3mfq5b8f06smvr8', 'x7gxp56fvm9n715l', 'bvnr9z3n4wvh1d5', 'k2vqgtfw3ls6z4l', '2ldl7p0d00k9830', '6qjrxgnj3js8ppr', 'k3w80d8w38pbh52', 'm5z8dv4z44c7c79', 'tc5mj2w506qzqqs', 'wf7mmz270dqcbqm', 'j2v63x5v37vdq5b', '9k50fn5h7qp4xb5f', 'x82xnfw0vhqq808m', '1c520mb9zfqdlm7j', 'lxqmlltgjn3r3rwq', 'lxqml4pgj5zcc04z', 'bvn22dhn4c8cmj2', 'tc5fx0m51vlg4vz', 'fzr3gr3r0qkldw4', 'j2v6kv6v1tsz22p', '7rksq52k11slz94', '5pht6hth56p87rb', 'wf7cwkm7466pnnn', '6qjw1zvj4l0x1sn', '6phfkz8j1806b8l', '4ngp0qkg3w4bmzt', 'sb48shv42g18k5x', 'h1t2q7jt0z60qz2', '1kcrsk4c40md2x5', '6qjvc35j2m6gnhp', 'r939t6231fgl5mh', 'bvn11rnn1vct377', 'tc58hsp55d1t22x', 'h1tzv04t4r5md8g', '2ldrrgcd1k9wcxj', '7rknd99k0jwv020', 'vd6hlp263nq5406', '7rkqsqsk34qthzn', 'p600w8c15p9x3vx', 'n603bkk05cctmj2', 'j2v6sxjv057cct7', 'j2v0j78v0pcrzcc', 'dxqtmmzq28292th', 'cwps0x6p4pjqftn', 'bvnsb13n0wbmtn6', 'q825fht25l07hj7', 'm5zbbs7z17vg4d5', 'g0s55bks4vs645g', '1kcd6n8c0l3vwp3', 'l4x9zflx1tqd7fs', '8slpxt7l0k92sv7', 'fxqq54br1wh77sw', 'tc5gfnq515lv7lx', 'n60clk503w54n9t', '2bj9t6z30p19h3cj', 'r124tvjbp0s8n0rl', 'dxqt5b5q3gc1rq2', 't3pswvzkr82gk81d', '6g25f3s545k2vsm5', 'x6sw1qg6v0jxlzx5', '3cz266r013qfp3kb', 't3pwcq2drmfj47lp', 't3pwbvwlrxd5jf1q', 'pzkpzbn1m3mt61d5', 'm5zfm96z1lcj9cs', 'jscc1ktbgvg002np', 'q0kk70cqn70wcr3f', 'bl5zl8fs879bksxs', 'dn77xsh1bfzgnq1s', 's28wft0tqbmkx1q7', 'cm66thxv959ctllw', '9krdt8zd78gmls34', 'x7k0sc8hv6j50g6r', 'dxq30r6q1nc1wbj', 'r93krcl30j2lsc7', 'r936d0m35rl1hvr', '2ldff70d5q37cl3', 'fzrts6wr2cfg2p7', 'k3wz6k0w514210l', '5phm5s4h2qxrzhv', 'sb4fzkt448lnrtd', 'n603bn901gfq52c', 'j2v712bv3tkbmr6', '8slzzl4l24z024g', 'q82ff3920x3qb6t', 'dxq33gzq19zm5tx', '6qjww63j366sck4', 'wf7bld0720jw0sm', 'cwp4l12p4qkctc6', 'q82jdgr20j7c2g5', 'dxq624jq21fr45w', 'wf7bpjh73c79nxk'"


/*
Using as template:
{
    "@graph": [
        {
            "@type": "Record",
            "@id": "https://id.kb.se/TEMPID",
            "descriptionCreator": {
                "@id": "https://libris.kb.se/library/S"
            },
            "mainEntity": {
                "@id": "https://id.kb.se/TEMPID#it"
            }
        },
        {
            "@id": "https://id.kb.se/TEMPID#it",
            "@type": "Item",
            "heldBy": {
                "@id": "https://libris.kb.se/library/S"
            },
            "itemOf": {
                "@id": "https://libris.kb.se/0jbnrcsb04grvf4#it"
            },
            "hasComponent": [
                {
                    "@type": "Item",
                    "heldBy": {
                        "@id": "https://libris.kb.se/library/S"
                    },
                    "hasNote": [
                        {
                            "@type": "Note",
                            "label": "F\u00f6rv\u00e4rvas ej av KB (annan utg\u00e5va finns)"
                        }
                    ]
                }
            ]
        }
    ]
}
*/

PrintWriter failedHoldIDs = getReportWriter("failed-holdIDs")
PrintWriter failedBibIDs = getReportWriter("failed-bibIDs")
PrintWriter scheduledForUpdating = getReportWriter("scheduled-for-update")

def holdList = []

String where = "id in ($bibIdList)"

selectBySqlWhere(where, silent: false) { bib ->

    def bibMainEntity = bib.graph[1]["@id"]

    def holdData =
            [ "@graph": [
                    [
                            "@id": "TEMPID",
                            "@type": "Record",
                            "mainEntity" : ["@id": "TEMPID#it"]
                    ],
                    [
                            "@id": "TEMPID#it",
                            "@type": "Item",
                            "heldBy": ["@id": "https://libris.kb.se/library/S"],
                            "itemOf": ["@id": bibMainEntity],
                            "hasComponent": [
                                    [
                                            "@type": "Item",
                                            "heldBy": ["@id": "https://libris.kb.se/library/S"],
                                            "hasNote": [
                                                    [
                                                            "@type": "Note",
                                                            "label": "Förvärvas ej av KB (annan utgåva finns)"
                                                    ]
                                            ]
                                    ]
                            ]
                    ]
            ]]

    holdList.add( create(holdData) )

    def technicalNote = bib.graph[0]["technicalNote"]
    def it = technicalNote.iterator()
    while (it.hasNext()) {
        def element = it.next()
        def labels = element["label"]
        def labelIt = labels.iterator()
        while (labelIt.hasNext()) {
            def label = labelIt.next()
            if (label.contains("ej av KB")) {
                labelIt.remove()
            }
        }
        if (labels != null && labels.size() == 0)
            it.remove()
    }
    if (technicalNote != null && technicalNote.size() == 0)
        bib.graph[0].remove("technicalNote")

    scheduledForUpdating.println("${bib.doc.getURI()}")
    bib.scheduleSave(onError: { e ->
        failedBibIDs.println("Failed to save ${bib.doc.shortId} due to: $e")
    })
}

selectFromIterable(holdList, { newlyCreatedItem ->
    newlyCreatedItem.scheduleSave(onError: { e ->
        // A number of these are expected to fail, since many of the SUEC bib records already have S holdings. This is ok.
        failedHoldIDs.println("Failed to save ${newlyCreatedItem.doc.shortId} due to: $e")
    })
})